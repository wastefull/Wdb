# WasteDB Local Development Setup Guide

## Overview

This guide explains how to run WasteDB locally after cloning from GitHub. The project uses:

- **Frontend**: React + TypeScript + Tailwind CSS (Vite/Figma Make)
- **Backend**: Supabase Edge Functions (Deno runtime)
- **Database**: Supabase (PostgreSQL + KV Store)
- **Auth**: Supabase Auth with magic links

---

## üìã Prerequisites

Before you begin, install:

1. **Node.js** (v18 or later)

   ```bash
   node --version  # Should be v18+
   ```

2. **Supabase CLI**

   ```bash
   npm install -g supabase
   supabase --version
   ```

3. **Git**
   ```bash
   git --version
   ```

---

## üîß Initial Setup

### Step 1: Clone the Repository

```bash
git clone <your-github-repo-url>
cd wastedb
```

### Step 2: Install Dependencies

```bash
npm install
```

### Step 3: Environment Configuration

The project has **two deployment modes**: **Remote Supabase** (production) or **Local Supabase** (development).

---

## üåê Option A: Remote Supabase (Recommended for Testing)

This connects to your existing production Supabase instance.

### 1. Get Your Supabase Credentials

From your [Supabase Dashboard](https://app.supabase.com):

1. Select your project
2. Go to **Settings** ‚Üí **API**
3. Copy these values:
   - **Project URL** (e.g., `https://bdvfwjmaufjeqmxphmtv.supabase.co`)
   - **Project ID** (e.g., `bdvfwjmaufjeqmxphmtv`)
   - **Anon/Public Key** (starts with `eyJhbGc...`)
   - **Service Role Key** (starts with `eyJhbGc...`) ‚ö†Ô∏è Keep secret!

### 2. Update `/utils/supabase/info.tsx`

```typescript
/* AUTOGENERATED FILE - DO NOT EDIT CONTENTS */

export const projectId = "YOUR_PROJECT_ID";
export const publicAnonKey = "YOUR_ANON_KEY";
```

### 3. Create `.env.local` File

Create a file named `.env.local` in the project root:

```bash
# Supabase Configuration
SUPABASE_URL=https://YOUR_PROJECT_ID.supabase.co
SUPABASE_ANON_KEY=YOUR_ANON_KEY
SUPABASE_SERVICE_ROLE_KEY=YOUR_SERVICE_ROLE_KEY
SUPABASE_DB_URL=postgresql://postgres:[YOUR-PASSWORD]@db.YOUR_PROJECT_ID.supabase.co:5432/postgres

# Optional: Email Service (if using Resend)
RESEND_API_KEY=your_resend_api_key_here
```

**‚ö†Ô∏è IMPORTANT**: Add `.env.local` to your `.gitignore`:

```bash
# .gitignore
.env.local
.env
node_modules/
dist/
```

### 4. Deploy Edge Functions (if changed)

If you've modified any files in `/supabase/functions/server/`:

```bash
# Link to your Supabase project
supabase link --project-ref YOUR_PROJECT_ID

# Deploy edge functions
supabase functions deploy make-server-17cae920
```

### 5. Initialize Ontologies

The app requires ontology data to be initialized in the database:

1. Run the development server (see Step 6)
2. Open browser console and run:
   ```javascript
   // Initialize ontologies
   await fetch(
     "https://YOUR_PROJECT_ID.supabase.co/functions/v1/make-server-17cae920/ontologies/initialize",
     {
       method: "POST",
       headers: { Authorization: "Bearer YOUR_ANON_KEY" },
     }
   );
   ```

Or use curl:

```bash
curl -X POST https://YOUR_PROJECT_ID.supabase.co/functions/v1/make-server-17cae920/ontologies/initialize \
  -H "Authorization: Bearer YOUR_ANON_KEY"
```

### 6. Run Development Server

```bash
npm run dev
```

Visit `http://localhost:5173` (or the port shown in terminal)

---

## üè† Option B: Local Supabase (Full Local Development)

This runs a complete local Supabase instance with Docker.

### 1. Start Local Supabase

```bash
# Initialize Supabase in project
supabase init

# Start local Supabase (requires Docker)
supabase start
```

This will output:

```
API URL: http://localhost:54321
DB URL: postgresql://postgres:postgres@localhost:54322/postgres
Studio URL: http://localhost:54323
Anon key: eyJhbGc...
Service Role key: eyJhbGc...
```

### 2. Update `/utils/supabase/info.tsx`

For **local development**, use a dynamic approach:

```typescript
/* AUTOGENERATED FILE - DO NOT EDIT CONTENTS */

export const projectId = import.meta.env.VITE_SUPABASE_PROJECT_ID || "local";
export const publicAnonKey =
  import.meta.env.VITE_SUPABASE_ANON_KEY || "eyJhbGc...";
```

### 3. Create `.env.local` File

```bash
# Local Supabase Configuration
VITE_SUPABASE_PROJECT_ID=local
VITE_SUPABASE_URL=http://localhost:54321
VITE_SUPABASE_ANON_KEY=<anon-key-from-supabase-start>
SUPABASE_SERVICE_ROLE_KEY=<service-role-key-from-supabase-start>
SUPABASE_DB_URL=postgresql://postgres:postgres@localhost:54322/postgres
```

### 4. Deploy Edge Functions Locally

```bash
# Deploy to local instance
supabase functions deploy make-server-17cae920 --project-ref local
```

### 5. Initialize Database

Run migrations (if you have any):

```bash
supabase db reset
```

Initialize ontologies:

```bash
curl -X POST http://localhost:54321/functions/v1/make-server-17cae920/ontologies/initialize \
  -H "Authorization: Bearer <your-local-anon-key>"
```

### 6. Run Development Server

```bash
npm run dev
```

Visit `http://localhost:5173`

---

## üß™ Environment-Specific Configuration

### Dynamic Environment Detection

Create `/utils/environment.ts` (if not exists):

```typescript
export const isDevelopment = import.meta.env.DEV;
export const isProduction = import.meta.env.PROD;

export const getSupabaseUrl = () => {
  return (
    import.meta.env.VITE_SUPABASE_URL || `https://${projectId}.supabase.co`
  );
};

export const getSupabaseAnonKey = () => {
  return import.meta.env.VITE_SUPABASE_ANON_KEY || publicAnonKey;
};
```

### Update API Calls

For edge function calls, use environment-aware URLs:

```typescript
import { projectId, publicAnonKey } from "./utils/supabase/info";
import { getSupabaseUrl } from "./utils/environment";

const baseUrl = getSupabaseUrl();
const apiUrl = `${baseUrl}/functions/v1/make-server-17cae920`;

// Example API call
const response = await fetch(`${apiUrl}/materials`, {
  headers: { Authorization: `Bearer ${publicAnonKey}` },
});
```

---

## üîê Authentication Setup

### Local Magic Links

For local development, Supabase provides a **test email provider**:

1. Visit local Studio: `http://localhost:54323`
2. Go to **Authentication** ‚Üí **Email Templates**
3. Magic link emails appear in the **Inbucket** inbox: `http://localhost:54324`

### Production Email Setup (Resend)

If using Resend for production magic links:

1. Sign up at [resend.com](https://resend.com)
2. Get API key
3. Add to Supabase Dashboard:
   - **Settings** ‚Üí **Auth** ‚Üí **SMTP Settings**
   - Host: `smtp.resend.com`
   - Port: `465`
   - User: `resend`
   - Password: `<your-resend-api-key>`

See `/docs/smtp/test/RESEND_SETUP_QUICK_GUIDE.md` for details.

---

## üì¶ Testing Configuration

### Run Phase 9 Tests

The app includes comprehensive test suites. After setup:

1. Sign in as admin
2. Navigate to **Roadmap** ‚Üí **Phase 9.2** tab
3. Click **Run Tests** to verify your setup

Tests check:

- ‚úÖ Ontology loading
- ‚úÖ Unit validation
- ‚úÖ Evidence CRUD operations
- ‚úÖ Database connectivity
- ‚úÖ Authentication flows

---

## üèóÔ∏è Project Structure

```
wastedb/
‚îú‚îÄ‚îÄ /components/          # React components
‚îú‚îÄ‚îÄ /contexts/            # React contexts (Auth, Materials, Navigation)
‚îú‚îÄ‚îÄ /config/              # Test definitions and phase configs
‚îÇ   ‚îî‚îÄ‚îÄ /tests/
‚îÇ       ‚îú‚îÄ‚îÄ /phases/      # Phase-specific test files
‚îÇ       ‚îî‚îÄ‚îÄ all.ts        # Centralized test aggregation
‚îú‚îÄ‚îÄ /data/                # Static data (sources, transforms)
‚îú‚îÄ‚îÄ /docs/                # Documentation
‚îú‚îÄ‚îÄ /ontologies/          # Ontology definitions (JSON + TS)
‚îú‚îÄ‚îÄ /styles/              # Global CSS and Tailwind config
‚îú‚îÄ‚îÄ /supabase/            # Supabase edge functions
‚îÇ   ‚îî‚îÄ‚îÄ /functions/
‚îÇ       ‚îî‚îÄ‚îÄ /server/      # Deno backend code
‚îÇ           ‚îú‚îÄ‚îÄ index.tsx           # Main server entry
‚îÇ           ‚îú‚îÄ‚îÄ kv_store.tsx        # KV utilities (DO NOT EDIT)
‚îÇ           ‚îú‚îÄ‚îÄ evidence-routes.tsx # Evidence endpoints
‚îÇ           ‚îî‚îÄ‚îÄ exports.tsx         # Export endpoints
‚îú‚îÄ‚îÄ /utils/               # Utility functions
‚îÇ   ‚îú‚îÄ‚îÄ /supabase/        # Supabase helpers
‚îÇ   ‚îú‚îÄ‚îÄ logger.ts         # Logging system
‚îÇ   ‚îî‚îÄ‚îÄ environment.ts    # Environment detection
‚îú‚îÄ‚îÄ /types/               # TypeScript types
‚îú‚îÄ‚îÄ App.tsx               # Main app component
‚îî‚îÄ‚îÄ .env.local            # Environment variables (DO NOT COMMIT)
```

---

## üêõ Troubleshooting

### Issue: "Failed to load units ontology"

**Solution**: Initialize ontologies via POST request:

```bash
curl -X POST <YOUR_SUPABASE_URL>/functions/v1/make-server-17cae920/ontologies/initialize \
  -H "Authorization: Bearer <YOUR_ANON_KEY>"
```

### Issue: "CORS error when calling edge functions"

**Solution**: Edge functions include CORS headers by default. Check:

1. Edge function is deployed: `supabase functions list`
2. Correct authorization header: `Bearer <anon-key>`
3. Check server logs: `supabase functions logs make-server-17cae920`

### Issue: "Cannot connect to local Supabase"

**Solution**:

1. Ensure Docker is running
2. Check Supabase status: `supabase status`
3. Restart Supabase: `supabase stop && supabase start`

### Issue: "Module not found" errors

**Solution**:

```bash
# Clear cache and reinstall
rm -rf node_modules package-lock.json
npm install
```

### Issue: "Unauthorized" when calling APIs

**Solution**:

1. Check you're signed in (run magic link flow)
2. Verify session in browser console:
   ```javascript
   const { data } = await supabase.auth.getSession();
   console.log(data.session);
   ```
3. Sign in again if session expired

### Issue: "Function deployment failed"

**Solution**:

```bash
# Link to project first
supabase link --project-ref YOUR_PROJECT_ID

# Try deploying with verbose output
supabase functions deploy make-server-17cae920 --debug
```

---

## Development Workflow

### Typical Development Cycle

```bash
# 1. Pull latest changes
git pull origin main

# 2. Install any new dependencies
npm install

# 3. Start local Supabase (if using local mode)
supabase start

# 4. Run dev server
npm run dev

# 5. Make changes to frontend code
# Files hot-reload automatically

# 6. Make changes to edge functions
# Redeploy after changes:
supabase functions deploy make-server-17cae920

# 7. Run tests to verify
# Navigate to Roadmap ‚Üí Phase 9.2 ‚Üí Run Tests

# 8. Commit and push
git add .
git commit -m "Your changes"
git push origin main
```

---

## üìù Environment Variables Reference

| Variable                    | Required       | Description                  | Example                  |
| --------------------------- | -------------- | ---------------------------- | ------------------------ |
| `VITE_SUPABASE_URL`         | Local only     | Supabase API URL             | `http://localhost:54321` |
| `VITE_SUPABASE_PROJECT_ID`  | Local only     | Project identifier           | `local`                  |
| `VITE_SUPABASE_ANON_KEY`    | Local only     | Public anon key              | `eyJhbGc...`             |
| `SUPABASE_SERVICE_ROLE_KEY` | Yes            | Admin key for edge functions | `eyJhbGc...`             |
| `SUPABASE_DB_URL`           | Edge functions | PostgreSQL connection        | `postgresql://...`       |
| `RESEND_API_KEY`            | Email only     | Resend API key for emails    | `re_xxx...`              |

---

## üîí Security Notes

‚ö†Ô∏è **NEVER commit these to Git**:

- `.env.local`
- `SUPABASE_SERVICE_ROLE_KEY`
- `RESEND_API_KEY`
- Production credentials

‚úÖ **Safe to commit**:

- `/utils/supabase/info.tsx` (contains only public keys)
- Example config files (with placeholder values)

---

## Additional Resources

- **Supabase Docs**: https://supabase.com/docs
- **Local Development**: https://supabase.com/docs/guides/cli/local-development
- **Edge Functions**: https://supabase.com/docs/guides/functions
- **Project Docs**: `/docs/` directory

---

## ‚úÖ Quick Checklist

After setup, you should have:

- [ ] Node.js v18+ installed
- [ ] Supabase CLI installed
- [ ] Project cloned from GitHub
- [ ] Dependencies installed (`npm install`)
- [ ] `.env.local` created with credentials
- [ ] Supabase connected (local or remote)
- [ ] Edge functions deployed
- [ ] Ontologies initialized
- [ ] Dev server running (`npm run dev`)
- [ ] Can sign in with magic link
- [ ] Phase 9.2 tests passing

---

## üéâ You're Ready!

Your local development environment is configured! Start the dev server and navigate to:

- **App**: http://localhost:5173
- **Supabase Studio** (local): http://localhost:54323
- **Inbucket** (local emails): http://localhost:54324

**Need help?** Check `/docs/` for detailed guides or open an issue on GitHub.
